<div class="card shadow">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div>
      <div class="fw-bold">Tests Observations</div>
      <div class="small text-muted">Order #: {{ order?.orderNumber || order?.orderSetId || '-' }}</div>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-secondary btn-sm" (click)="cancel.emit()">Back</button>
      <button class="btn btn-success btn-sm" (click)="onComplete()">
        <i class="fas fa-check me-1"></i> Complete
      </button>
    </div>
  </div>   

  <form class="card-body" [formGroup]="completionForm">
    <!-- Test Information -->
    <div class="form-section">
      <h6 class="mb-3">Lab Result</h6>
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Perform Date</label>
          <div class="input-group">
            <input class="form-control form-control-sm"
                  placeholder="yyyy-mm-dd"
                  [minDate]="minDate"
                  [markDisabled]="isDisabled"
                  ngbDatepicker
                  #d="ngbDatepicker"
                  [formControl]="performDateControl">
            <button class="btn btn-outline-secondary btn-sm" 
                   (click)="openDatePicker(d)" 
                   type="button">
              <i class="far fa-calendar-alt"></i>
            </button>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Action</label>
          <select class="form-select form-select-sm" formControlName="action">
            <option value="">Select Action</option>
            <option value="Reported">Reported</option>
            <option value="Corrected">Corrected</option>
            <option value="Final">Final</option>
            <option value="Preliminary">Preliminary</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Reviewed By</label>
          <input type="text" class="form-control form-control-sm" formControlName="reviewedBy">
        </div>
        <div class="col-md-3">
          <label class="form-label">Reviewed Date</label>
          <input type="date" class="form-control form-control-sm" formControlName="reviewedDate">
        </div>
      </div>
    </div>

    <!-- Test Details -->
    <div class="form-section">
      <h6 class="mb-3">Test Details</h6>
      <div class="table-responsive">
        <table class="table table-sm table-bordered">
          <thead>
            <tr>
              <th>Test Name</th>
              <th>Material</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let test of tests">
              <td>{{ test.name || test.testName || test.cpt }}</td>
              <td>{{ test.material || test.materialName || test.sampleTypeName || '-' }}</td>
              <td>{{ test.status || 'In Progress' }}</td>
            </tr>
            <tr *ngIf="tests.length === 0">
              <td colspan="3" class="text-center text-muted">No tests selected</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Observations (hidden by default; controlled by showObservations input) -->
    <div class="form-section" formArrayName="observations" *ngIf="showObservations">
      <h6 class="mb-3">Observations</h6>
      <div class="table-responsive">
        <table class="table table-sm table-bordered mb-2">
          <thead>
            <tr>
              <th style="width: 60px;">Default Result</th>
              <th style="width: 400px;">Test</th>
              <th>Value Type</th>
              <th>Element Name</th>
              <th>Abbreviation</th>
              <th>Value</th>
              <th>Unit</th>
              <th>Minimum Value</th>
              <th>Maximum Value</th>
              <th>Abnormal Flag</th>
              <th>Result Status</th>
              <th>Observation Entry Date</th>
              <th>Observation Analysis Date</th>
              <th>Remarks</th>
              <th style="width: 40px;"></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let obs of observations.controls; let i = index" [formGroupName]="i">
              <td class="text-center">
                <input class="form-check-input" type="checkbox" formControlName="weqayaScreening">
              </td>
              <td>
                <select class="form-select form-select-sm" 
                        formControlName="selectedTest"
                        (change)="onTestSelectionChange(i, $any($event.target).value)">
                  <option [value]="''">Select Test</option>
                  <option *ngFor="let test of tests" 
                          [value]="test.orderSetDetailId || test.id">
                    {{ test.name || test.testName || test.cpt }}
                  </option>
                </select>
              </td>
              <td>
                <select class="form-select form-select-sm" formControlName="valueType">
                  <option value="">Select</option>
                  <option value="NM">Numeric (NM)</option>
                  <option value="ST">String (ST)</option>
                  <option value="CWE">Coded (CWE)</option>
                  <option value="DT">Date (DT)</option>
                  <option value="TM">Time (TM)</option>
                  <option value="TS">Time Stamp (TS)</option>
                </select>
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" formControlName="observationIdentifierFullName">
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" formControlName="observationIdentifierShortName">
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" formControlName="observationValue">
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" formControlName="units">
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" formControlName="referenceRangeMin">
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" formControlName="referenceRangeMax">
              </td>
              <td>
                <select class="form-select form-select-sm" formControlName="abnormalFlag">
                  <option value="">None</option>
                  <option value="H">High</option>
                  <option value="L">Low</option>
                  <option value="A">Abnormal</option>
                  <option value="N">Normal</option>
                </select>
              </td>
              <td>
                <select class="form-select form-select-sm" formControlName="resultStatus">
                  <option value="">Select</option>
                  <option value="F">Final</option>
                  <option value="P">Preliminary</option>
                  <option value="C">Corrected</option>
                  <option value="X">Cancelled</option>
                </select>
              </td>
              <td>
                <input type="date" class="form-control form-control-sm" formControlName="observationDateTime">
              </td>
              <td>
                <input type="date" class="form-control form-control-sm" formControlName="analysisDateTime">
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" formControlName="remarks">
              </td>
              <td class="text-center">
                <button type="button" class="btn btn-sm btn-link text-danger p-0" (click)="removeObservation(i)" [disabled]="observations.length <= 1">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <button type="button" class="btn btn-primary btn-sm" (click)="addObservation()">Add Row</button>
    </div>

    <!-- Attachments / Notes tabs -->
    <div class="mt-3">
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <button
            class="nav-link"
            [class.active]="activeTab === 'attachments'"
            type="button"
            (click)="activeTab = 'attachments'">
            Attachments
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            [class.active]="activeTab === 'notes'"
            type="button"
            (click)="activeTab = 'notes'">
            Notes
          </button>
        </li>
      </ul>

      <div class="tab-content border border-top-0 w-100" style="background-color: var(--bs-body-bg);">
        <!-- Attachments tab: reuse global generic document upload component -->
        <div class="tab-pane fade show" [class.active]="activeTab === 'attachments'">
          <app-generic-document-upload></app-generic-document-upload>
        </div>

        <!-- Notes tab: rich text note using Quill editor -->
        <div class="tab-pane fade show w-100" [class.active]="activeTab === 'notes'">
          <div class="w-100">
            <!-- <label class="form-label fw-semibold">Note</label> -->
            <quill-editor
              [(ngModel)]="noteText"
              name="ivfOrderNote"
              [modules]="quillModules"
              format="html"
              placeholder="Enter medical opinion or notes..."
              class="w-100"
              [styles]="{height: '120px', width: '100%'}">
            </quill-editor>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
