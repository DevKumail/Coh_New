<div class="modal-scroll-container">
<div class="card shadow">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div>
      <div class="fw-bold">Tests Observations</div>
      <div class="small text-muted">Order #: {{ order?.orderNumber || order?.orderSetId || '-' }}</div>
    </div>
    <button type="button" class="btn-close" aria-label="Close" (click)="cancel.emit()"></button>
  </div>   

  <form class="card-body" [formGroup]="completionForm">
    <!-- Skeleton Loader -->
    <ng-container *ngIf="isLoading">
      <div class="mb-2">
        <h6 class="mb-2 fw-semibold">Lab Result</h6>
        <div class="row g-1">
          <div class="col-md-3" *ngFor="let i of [1,2,3,4]">
            <div class="placeholder-glow">
              <span class="placeholder col-6 mb-1" style="height: 14px;"></span>
              <span class="placeholder col-12" style="height: 31px;"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="mb-1">
        <h6 class="mb-1 fw-semibold">Test Details</h6>
        <div class="table-responsive">
          <table class="table table-bordered table-striped table-sm">
            <thead>
              <tr>
                <th>Test Name</th>
                <th>Material</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let i of [1,2]">
                <td><span class="placeholder col-8"></span></td>
                <td><span class="placeholder col-5"></span></td>
                <td><span class="placeholder col-4"></span></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="mt-1">
        <ul class="nav nav-tabs custom-tabs">
          <li class="nav-item">
            <button class="nav-link active" type="button">Attachments</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" type="button">Notes</button>
          </li>
        </ul>
        <div class="tab-content border border-top-0 p-3 bg-white">
          <div class="placeholder-glow">
            <span class="placeholder col-12 mb-2" style="height: 40px;"></span>
            <span class="placeholder col-12 mb-2" style="height: 40px;"></span>
            <span class="placeholder col-8" style="height: 40px;"></span>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- Actual Content -->
    <ng-container *ngIf="!isLoading">
    <!-- Test Information -->
    <div class="mb-2">
      <h6 class="mb-2 fw-semibold">Lab Result</h6>
      <div class="row g-1">
        <div class="col-md-3">
          <label class="form-label mb-1 small">Perform Date</label>
          <div class="input-group input-group-sm">
            <input class="form-control"
                  placeholder="yyyy-mm-dd"
                  [minDate]="minDate"
                  [markDisabled]="isDisabled"
                  ngbDatepicker
                  #d="ngbDatepicker"
                  [formControl]="performDateControl">
            <button class="btn btn-outline-secondary" 
                   (click)="openDatePicker(d)" 
                   type="button">
              <i class="far fa-calendar-alt"></i>
            </button>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label mb-1 small">Action</label>
          <select class="form-select form-select-sm" formControlName="action">
            <option value="">Select Action</option>
            <option value="Reported">Reported</option>
            <option value="Corrected">Corrected</option>
            <option value="Final">Final</option>
            <option value="Preliminary">Preliminary</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label mb-1 small">Reviewed By</label>
          <input type="text" class="form-control form-control-sm" formControlName="reviewedBy">
        </div>
        <div class="col-md-3">
          <label class="form-label mb-1 small">Reviewed Date</label>
          <input type="date" class="form-control form-control-sm" formControlName="reviewedDate">
        </div>
      </div>
    </div>

    <!-- Test Details -->
    <div class="mb-1">
      <h6 class="mb-1 fw-semibold">Test Details</h6>
      <div class="table-responsive">
        <table class="table table-bordered table-striped table-sm">
          <thead>
            <tr>
              <th>Test Name</th>
              <th>Material</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody class="table-group-divider">
            <tr *ngFor="let test of tests">
              <td>{{ test.name || test.testName || test.cpt }}</td>
              <td>{{ test.material || test.materialName || test.sampleTypeName || '-' }}</td>
              <td>{{ test.status || 'In Progress' }}</td>
            </tr>
            <tr *ngIf="tests.length === 0">
              <td colspan="3" class="text-center text-muted">No tests selected</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Observations (hidden by default; controlled by showObservations input) -->
    <div class="mb-1" formArrayName="observations" *ngIf="showObservations">
      <h6 class="mb-2 fw-semibold">Observations</h6>
      <div class="table-responsive">
        <table class="table table-sm table-bordered mb-2">
          <thead>
            <tr>
              <th style="width: 60px;">Default Result</th>
              <th style="width: 400px;">Test</th>
              <th>Value Type</th>
              <th>Element Name</th>
              <th>Abbreviation</th>
              <th>Value</th>
              <th>Unit</th>
              <th>Minimum Value</th>
              <th>Maximum Value</th>
              <th>Abnormal Flag</th>
              <th>Result Status</th>
              <th>Observation Entry Date</th>
              <th>Observation Analysis Date</th>
              <th>Remarks</th>
              <th style="width: 40px;"></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let obs of observations.controls; let i = index" [formGroupName]="i">
              <td class="text-center">
                <input class="form-check-input" type="checkbox" formControlName="weqayaScreening">
              </td>
              <td>
                <select class="form-select form-select-sm" 
                        formControlName="selectedTest"
                        (change)="onTestSelectionChange(i, $any($event.target).value)">
                  <option [value]="''">Select Test</option>
                  <option *ngFor="let test of tests" 
                          [value]="test.orderSetDetailId || test.id">
                    {{ test.name || test.testName || test.cpt }}
                  </option>
                </select>
              </td>
              <td>
                <select class="form-select form-select-sm" formControlName="valueType">
                  <option value="">Select</option>
                  <option value="NM">Numeric (NM)</option>
                  <option value="ST">String (ST)</option>
                  <option value="CWE">Coded (CWE)</option>
                  <option value="DT">Date (DT)</option>
                  <option value="TM">Time (TM)</option>
                  <option value="TS">Time Stamp (TS)</option>
                </select>
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" formControlName="observationIdentifierFullName">
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" formControlName="observationIdentifierShortName">
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" formControlName="observationValue">
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" formControlName="units">
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" formControlName="referenceRangeMin">
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" formControlName="referenceRangeMax">
              </td>
              <td>
                <select class="form-select form-select-sm" formControlName="abnormalFlag">
                  <option value="">None</option>
                  <option value="H">High</option>
                  <option value="L">Low</option>
                  <option value="A">Abnormal</option>
                  <option value="N">Normal</option>
                </select>
              </td>
              <td>
                <select class="form-select form-select-sm" formControlName="resultStatus">
                  <option value="">Select</option>
                  <option value="F">Final</option>
                  <option value="P">Preliminary</option>
                  <option value="C">Corrected</option>
                  <option value="X">Cancelled</option>
                </select>
              </td>
              <td>
                <input type="date" class="form-control form-control-sm" formControlName="observationDateTime">
              </td>
              <td>
                <input type="date" class="form-control form-control-sm" formControlName="analysisDateTime">
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" formControlName="remarks">
              </td>
              <td class="text-center">
                <button type="button" class="btn btn-sm btn-link text-danger p-0" (click)="removeObservation(i)" [disabled]="observations.length <= 1">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <button type="button" class="btn btn-primary btn-sm" (click)="addObservation()">Add Row</button>
    </div>

    <!-- Attachments / Notes tabs -->
    <div class="mt-1">
      <ul class="nav nav-tabs custom-tabs">
        <li class="nav-item">
          <button
            class="nav-link"
            [class.active]="activeTab === 'attachments'"
            type="button"
            (click)="activeTab = 'attachments'">
            Attachments
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            [class.active]="activeTab === 'notes'"
            type="button"
            (click)="activeTab = 'notes'">
            Notes
          </button>
        </li>
      </ul>

      <div class="tab-content border border-top-0 p-3 bg-white">
        <!-- Attachments tab: reuse global generic document upload component -->
        <div class="tab-pane fade" [class.show]="activeTab === 'attachments'" [class.active]="activeTab === 'attachments'">
          <app-generic-document-upload #uploader></app-generic-document-upload>
        </div>

        <!-- Notes tab: rich text note using Quill editor -->
        <div class="tab-pane fade" [class.show]="activeTab === 'notes'" [class.active]="activeTab === 'notes'">
          <quill-editor
            [(ngModel)]="noteText"
            [ngModelOptions]="{ standalone: true }"
            name="ivfOrderNote"
            [modules]="quillModules"
            format="html"
            placeholder="Enter medical opinion or notes..."
            [styles]="{height: '200px'}">
          </quill-editor>
        </div>
      </div>
    </div>
    </ng-container>
  </form>

  <!-- Footer with Action Buttons -->
  <div class="card-footer d-flex justify-content-end gap-2 bg-white">
    <button class="btn btn-secondary btn-sm" (click)="cancel.emit()" [disabled]="isSaving || isLoading">
      Cancel
    </button>
    <button class="btn btn-complete btn-sm" (click)="onComplete()" [disabled]="isSaving || isLoading">
      <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
      {{ isSaving ? 'Saving...' : 'Complete' }}
    </button>
  </div>
</div>
</div>
