<!-- Question Section with Collapse/Expand - Full Width -->
<div *ngIf="question.type === 'Question Section'" class="question-section section-header" style="margin-left: 20px; margin-top: 10px;">
  <h4
    class="d-flex align-items-center gap-2"
    style="cursor: pointer; user-select: none; padding: 10px 15px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid #0ACF97; transition: all 0.2s ease;"
    (click)="toggleSection()"
    (mouseenter)="onMouseEnter($event)"
    (mouseleave)="onMouseLeave($event)">
    <!-- Main Collapse/Expand Icon (Left side) -->
    <span style="font-size: 1.2rem; color: #0ACF97; font-weight: bold; min-width: 20px;">
      {{ isCollapsed ? '▶' : '▼' }}
    </span>
    <span style="font-weight: 600;">{{ question.quest_Title }}</span>
  </h4>

  <!-- Custom Component (only for sections WITHOUT children) -->
  <div *ngIf="shouldRenderCustomComponent()"
       class="custom-component-container"
       style="margin-left: 15px; padding-left: 10px; border-left: 2px solid #0ACF97; margin-top: 10px;">

    <!-- Dynamically render component based on section -->
    <ng-container [ngSwitch]="getComponentSelector()">
      <!-- Medical History renders ProblemListComponent -->
      <app-problem-list
        #problemListRef
        [clinicalnote]="clinicalnote"
        [preSelectedIds]="selectedMedicalHistoryIds"
        (selectionChanged)="handleMedicalHistorySelection($event)"
        *ngSwitchCase="'app-medical-history'">
      </app-problem-list>
      <app-medication [clinicalnote]="clinicalnote" *ngSwitchCase="'app-medication'"></app-medication>
      <app-family-history
        #familyHistoryRef
        [clinicalnote]="clinicalnote"
        [preSelectedIds]="selectedFamilyHistoryIds"
        (selectionChanged)="handleFamilyHistorySelection($event)"
        *ngSwitchCase="'app-family-history'">
      </app-family-history>
      <app-social-history
        #socialHistoryRef
        [clinicalnote]="clinicalnote"
        [preSelectedIds]="selectedSocialHistoryIds"
        (selectionChanged)="handleSocialHistorySelection($event)"
        *ngSwitchCase="'app-social-history'">
      </app-social-history>
      <app-allergies
        #allergiesRef
        [clinicalnote]="clinicalnote"
        [preSelectedIds]="selectedAllergiesIds"
        (selectionChanged)="handleAllergiesSelection($event)"
        *ngSwitchCase="'app-allergies'">
      </app-allergies>
      <app-vital-signs
        #vitalSignsRef
        [clinicalnote]="clinicalnote"
        [preSelectedIds]="selectedVitalSignsIds"
        (selectionChanged)="handleVitalSignsSelection($event)"
        *ngSwitchCase="'app-vital-signs'">
      </app-vital-signs>
      <app-immunizations
        #immunizationsRef
        [clinicalnote]="clinicalnote"
        [preSelectedIds]="selectedImmunizationsIds"
        (selectionChanged)="handleImmunizationsSelection($event)"
        *ngSwitchCase="'app-immunizations'">
      </app-immunizations>
      <!-- Problem section renders ProblemComponent -->
      <app-problem [clinicalnote]="clinicalnote" *ngSwitchCase="'app-problem'"></app-problem>
    </ng-container>
  </div>

  <!-- Default Children (for sections WITH children) -->
  <div
    *ngIf="shouldRenderDefaultChildren() && !isSocialHistorySection() && !isFamilyHistorySection() && !isAllergiesSection() && !isMedicalHistorySection() && !isVitalSignsSection() && !isImmunizationsSection()"
    class="children-container"
    style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-left: 15px; padding-left: 10px; border-left: 2px solid #0ACF97; margin-top: 10px;">
    <app-question-view
      *ngFor="let child of question.children"
      [question]="child"
      [form]="form"
      [hasParent]="true">
    </app-question-view>
  </div>
</div>

<!-- TextBox Type - Collapsable only if no parent -->
<div *ngIf="question.type === 'TextBox'" class="mb-3" [style.margin-left]="hasParent ? '0' : '20px'">
  <!-- Collapsable Header (only for standalone questions) -->
  <div *ngIf="isCollapsable()"
    class="d-flex align-items-center gap-2"
    style="cursor: pointer; user-select: none; padding: 8px 12px; background-color: #f8f9fa; border-radius: 6px; border-left: 3px solid #0ACF97; transition: all 0.2s ease;"
    (click)="toggleSection()"
    (mouseenter)="onMouseEnter($event)"
    (mouseleave)="onMouseLeave($event)">
    <span style="font-size: 1rem; color: #0ACF97; font-weight: bold; min-width: 18px;">
      {{ isCollapsed ? '▶' : '▼' }}
    </span>
    <span class="fw-semibold" style="font-size: 0.95rem;">{{ question.quest_Title }}</span>
  </div>

  <!-- Simple Label (for child questions) -->
  <label *ngIf="!isCollapsable()" class="form-label fw-semibold" style="font-size: 0.9rem;">
    {{ question.quest_Title }}
  </label>

  <div *ngIf="shouldShowInputField()" [style.margin-top]="isCollapsable() ? '8px' : '0'" [style.margin-left]="isCollapsable() ? '30px' : '0'">
    <input
      type="text"
      [value]="question.answer || ''"
      (input)="onAnswerChange($event, question)"
      class="form-control form-control-sm"
      placeholder="Enter {{ question.quest_Title }}"
    />
  </div>
</div>

<!-- CheckBox Type - Collapsable only if no parent -->
<div *ngIf="question.type === 'CheckBox'" class="mb-3" [style.margin-left]="hasParent ? '0' : '20px'">
  <!-- Collapsable Header (only for standalone questions) -->
  <div *ngIf="isCollapsable()"
    class="d-flex align-items-center gap-2"
    style="cursor: pointer; user-select: none; padding: 8px 12px; background-color: #f8f9fa; border-radius: 6px; border-left: 3px solid #0ACF97; transition: all 0.2s ease;"
    (click)="toggleSection()"
    (mouseenter)="onMouseEnter($event)"
    (mouseleave)="onMouseLeave($event)">
    <span style="font-size: 1rem; color: #0ACF97; font-weight: bold; min-width: 18px;">
      {{ isCollapsed ? '▶' : '▼' }}
    </span>
    <span class="fw-semibold" style="font-size: 0.95rem;">{{ question.quest_Title }}</span>
  </div>

  <!-- Simple Checkbox (for child questions) -->
  <label *ngIf="!isCollapsable()" class="d-flex align-items-center gap-2">
    <input
      type="checkbox"
      [checked]="isChecked(question.answer)"
      (change)="onCheckboxChange($event, question)"
      style="cursor: pointer;"
    />
    <span>{{ question.quest_Title }}</span>
  </label>

  <div *ngIf="shouldShowInputField() && isCollapsable()" style="margin-top: 8px; margin-left: 30px;">
    <label class="d-flex align-items-center gap-2">
      <input
        type="checkbox"
        [checked]="isChecked(question.answer)"
        (change)="onCheckboxChange($event, question)"
        style="cursor: pointer;"
      />
      <span>{{ question.quest_Title }}</span>
    </label>
  </div>
</div>

