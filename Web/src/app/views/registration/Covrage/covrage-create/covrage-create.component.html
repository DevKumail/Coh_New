<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
  <ol class="breadcrumb bg-light bg-opacity-50 p-2">
    <li class="breadcrumb-item">
      <a href="javascript:void(0);">
        <ng-icon name="tablerSmartHome"></ng-icon>
        Registration
      </a>
    </li>
    <li class="d-flex align-items-center text-muted mx-1" aria-current="page">
      <ng-icon name="tablerChevronRight"></ng-icon>
    </li>
    <li class="breadcrumb-item active" aria-current="page">
      Coverage
    </li>
  </ol>
</nav>


<!-- <div class="container-fluid mt-3"> -->
    <div class="card shadow-lg p-2 rounded">
        <!-- 🔷 Optional Breadcrumb -->
        <div class="d-flex justify-content-between align-items-center p-2">
            <h4 class="fw-bold mb-0">Add Subscriber</h4>
        </div>

        <!-- 📝 Reactive Form Starts -->
        <form [formGroup]="subscriberForm" novalidate class="no-invalid-icon">
            <div class="row p-2">
                <!-- Type -->
                <div class="col-3">
                    <label>Type</label><span class="danger"> *</span>
                   <select
                        class="form-select no-invalid-icon"
                        formControlName="CompanyOrIndividual"
                        (change)="showRelation()"
                        [class.is-invalid]="subscriberForm.get('CompanyOrIndividual')?.invalid && (subscriberForm.get('CompanyOrIndividual')?.touched || subscriberForm.touched)"
                    >
                        <option value="">-- Select Type --</option>
                        <option *ngFor="let t of type" [value]="t.value" >
                            {{ t.label }}
                        </option>
                    </select>
                    <div class="invalid-feedback d-block" *ngIf="subscriberForm.get('CompanyOrIndividual')?.invalid && (subscriberForm.get('CompanyOrIndividual')?.touched || subscriberForm.touched)">
                        Type is required.
                    </div>

                </div>

                <!-- Relationship Dropdown (Show only if isRelation == true) -->
                <div class="col-3">
                    <label>Relation</label><span class="danger"> *</span>
                    <select
                        class="form-select no-invalid-icon"
                        formControlName="InsuranceRel"
                        id="InsuranceRel"
                        [disabled]="!isRelation"
                        [class.is-invalid]="subscriberForm.get('InsuranceRel')?.invalid && (subscriberForm.get('InsuranceRel')?.touched || subscriberForm.touched)"
                    >
                        <option value="">-- Select Relation --</option>
                        <option
                            *ngFor="let t of InsuranceRelation"
                            [value]="t.id"
                        >
                            {{ t.name }}
                        </option>
                    </select>
                    <div class="invalid-feedback d-block" *ngIf="subscriberForm.get('InsuranceRel')?.invalid && (subscriberForm.get('InsuranceRel')?.touched || subscriberForm.touched)">
                        Relation is required.
                    </div>
                </div>

                <!-- Title -->
                <div class="col-3">
                    <label>Title</label><span class="danger"> *</span>
                    <select class="form-select no-invalid-icon" formControlName="Suffix"
                        [class.is-invalid]="subscriberForm.get('Suffix')?.invalid && (subscriberForm.get('Suffix')?.touched || subscriberForm.touched)">
                        <option value="">-- Select Title --</option>
                        <option *ngFor="let t of titles" [value]="t.code">
                            {{ t.name }}
                        </option>
                    </select>
                    <div class="invalid-feedback d-block" *ngIf="subscriberForm.get('Suffix')?.invalid && (subscriberForm.get('Suffix')?.touched || subscriberForm.touched)">
                        Title is required.
                    </div>
                </div>

                <!-- First Name -->
                <div class="col-3">
                    <label>First Name</label><span class="danger"> *</span>
                    <input
                        type="text"
                        class="form-control no-invalid-icon"
                        formControlName="FirstName"
                        placeholder="First Name"
                        [class.is-invalid]="subscriberForm.get('FirstName')?.invalid && (subscriberForm.get('FirstName')?.touched || subscriberForm.touched)"
                    />
                    <div class="invalid-feedback d-block" *ngIf="subscriberForm.get('FirstName')?.invalid && (subscriberForm.get('FirstName')?.touched || subscriberForm.touched)">
                        First name is required.
                    </div>
                </div>

                <!-- Middle Name -->
                <div class="col-3">
                    <label>Middle Name</label>
                    <input
                        type="text"
                        class="form-control no-invalid-icon"
                        formControlName="MiddleName"
                        placeholder="Middle Name"
                    />
                </div>

                <!-- Last Name -->
                <div class="col-3">
                    <label>Last Name</label><span class="danger"> *</span>
                    <input
                        type="text"
                        class="form-control no-invalid-icon"
                        formControlName="LastName"
                        placeholder="Last Name"
                        [class.is-invalid]="subscriberForm.get('LastName')?.invalid && (subscriberForm.get('LastName')?.touched || subscriberForm.touched)"
                    />
                    <div class="invalid-feedback d-block" *ngIf="subscriberForm.get('LastName')?.invalid && (subscriberForm.get('LastName')?.touched || subscriberForm.touched)">
                        Last name is required.
                    </div>
                </div>

                <!-- Phone -->
                <div class="col-3">
                    <label>Cell Phone</label><span class="danger"> *</span>

                    <input
                        type="text"
                        class="form-control no-invalid-icon"
                        formControlName="InsuredPhone"
                        placeholder="(00) 0000-0000"
                        [mask]="'(00) 0000-0000'"
                        [class.is-invalid]="subscriberForm.get('InsuredPhone')?.invalid && (subscriberForm.get('InsuredPhone')?.touched || subscriberForm.touched)"
                    />
                    <div class="invalid-feedback d-block" *ngIf="subscriberForm.get('InsuredPhone')?.invalid && (subscriberForm.get('InsuredPhone')?.touched || subscriberForm.touched)">
                        Cell phone is required.
                    </div>
                </div>

                <div class="col-3">
                    <label>Date of Birth</label><span class="danger"> *</span>
                    <input
                        type="text"
                        class="form-control date no-invalid-icon"
                        formControlName="BirthDate"
                        data-provider="flatpickr"
                        id="BirthDate"
                        placeholder="Select date"
                        [class.is-invalid]="subscriberForm.get('BirthDate')?.invalid && (subscriberForm.get('BirthDate')?.touched || subscriberForm.touched)"
                    />
                    <div class="invalid-feedback d-block" *ngIf="subscriberForm.get('BirthDate')?.invalid && (subscriberForm.get('BirthDate')?.touched || subscriberForm.touched)">
                        Date of birth is required.
                    </div>
                </div>

                <!-- Address -->
                <div class="col-3">
                    <label>Address</label><span class="danger"> *</span>
                    <textarea
                        class="form-control no-invalid-icon"
                        formControlName="Address1"
                        placeholder="Address"
                        [class.is-invalid]="subscriberForm.get('Address1')?.invalid && (subscriberForm.get('Address1')?.touched || subscriberForm.touched)"
                    ></textarea>
                    <div class="invalid-feedback d-block" *ngIf="subscriberForm.get('Address1')?.invalid && (subscriberForm.get('Address1')?.touched || subscriberForm.touched)">
                        Address is required.
                    </div>
                </div>

                <!-- Country -->
                <div class="col-3">
                    <label>Country</label><span class="danger"> *</span>
                    <select
                        class="form-select no-invalid-icon"
                        formControlName="CountryId"
                        (change)="onCountryChange()"
                        [class.is-invalid]="subscriberForm.get('CountryId')?.invalid && (subscriberForm.get('CountryId')?.touched || subscriberForm.touched)"
                    >
                        <option value="">-- Select Country --</option>
                        <option *ngFor="let c of Country" [value]="c.code">
                            {{ c.name }}
                        </option>
                    </select>
                    <div class="invalid-feedback d-block" *ngIf="subscriberForm.get('CountryId')?.invalid && (subscriberForm.get('CountryId')?.touched || subscriberForm.touched)">
                        Country is required.
                    </div>
                </div>

                <!-- State -->
                <div class="col-3">
                    <label>State</label><span class="danger"> *</span>
                    <select
                        class="form-select no-invalid-icon"
                        formControlName="StateId"
                        (change)="onStateChange()"
                        [class.is-invalid]="subscriberForm.get('StateId')?.invalid && (subscriberForm.get('StateId')?.touched || subscriberForm.touched)"
                    >
                        <option value="">-- Select State --</option>
                        <option *ngFor="let s of states" [value]="s.stateId">
                            {{ s.name }}
                        </option>
                    </select>
                    <div class="invalid-feedback d-block" *ngIf="subscriberForm.get('StateId')?.invalid && (subscriberForm.get('StateId')?.touched || subscriberForm.touched)">
                        State is required.
                    </div>
                </div>

                <!-- City -->
                <div class="col-3">
                    <label>City</label><span class="danger"> *</span>
                    <select class="form-select no-invalid-icon" formControlName="CityId"
                        [class.is-invalid]="subscriberForm.get('CityId')?.invalid && (subscriberForm.get('CityId')?.touched || subscriberForm.touched)">
                        <option value="">-- Select City --</option>
                        <option *ngFor="let c of city" [value]="c.cityId">
                            {{ c.name }}
                        </option>
                    </select>
                    <div class="invalid-feedback d-block" *ngIf="subscriberForm.get('CityId')?.invalid && (subscriberForm.get('CityId')?.touched || subscriberForm.touched)">
                        City is required.
                    </div>
                </div>

                <!-- Zip -->
                <div class="col-3">
                    <label>Zip Code</label><span class="danger"> *</span>
                    <input
                        type="text"
                        class="form-control no-invalid-icon"
                        formControlName="ZipCode"
                        placeholder="Zip Code"
                        [mask]="'00000'"
                        [class.is-invalid]="subscriberForm.get('ZipCode')?.invalid && (subscriberForm.get('ZipCode')?.touched || subscriberForm.touched)"
                    />
                    <div class="invalid-feedback d-block" *ngIf="subscriberForm.get('ZipCode')?.invalid && (subscriberForm.get('ZipCode')?.touched || subscriberForm.touched)">
                        Zip code is required.
                    </div>
                </div>

                <!-- Insurance Carrier -->
                <div class="col-3">
                    <label>Insurance Carrier</label
                    ><span class="danger"> *</span>
                    <select
                        class="form-select no-invalid-icon"
                        formControlName="CarrierId"
                        (change)="onCarrierChange()"
                        [class.is-invalid]="subscriberForm.get('CarrierId')?.invalid && (subscriberForm.get('CarrierId')?.touched || subscriberForm.touched)"
                    >
                        <option *ngFor="let p of BLPayer" [value]="p.code">
                            {{ p.name }}
                        </option>
                    </select>
                    <div class="invalid-feedback d-block" *ngIf="subscriberForm.get('CarrierId')?.invalid && (subscriberForm.get('CarrierId')?.touched || subscriberForm.touched)">
                        Insurance Carrier is required.
                    </div>
                </div>

                <div class="col-3">
                    <label>Policy Plan</label><span class="danger"> *</span>
                    <select
                        class="form-select policy-select no-invalid-icon"
                        formControlName="selectedBLPayerPlan"
                        [class.is-invalid]="subscriberForm.get('selectedBLPayerPlan')?.invalid && (subscriberForm.get('selectedBLPayerPlan')?.touched || subscriberForm.touched)"
                    >
                        <option
                            *ngFor="let plan of BLPayerPlan"
                            [value]="plan.code"
                            [title]="plan.name"
                        >
                            {{ plan.name }}
                        </option>
                    </select>
                    <div class="invalid-feedback d-block" *ngIf="subscriberForm.get('selectedBLPayerPlan')?.invalid && (subscriberForm.get('selectedBLPayerPlan')?.touched || subscriberForm.touched)">
                        Policy Plan is required.
                    </div>
                </div>

                <!-- Package -->
                <div class="col-3">
                    <label>Package</label><span class="danger"> *</span>
                    <select
                        class="form-select no-invalid-icon"
                        formControlName="selectedBLPayerPackage"
                        [class.is-invalid]="subscriberForm.get('selectedBLPayerPackage')?.invalid && (subscriberForm.get('selectedBLPayerPackage')?.touched || subscriberForm.touched)"
                    >
                        <option
                            *ngFor="let pack of BLPayerPackage"
                            [value]="pack.code"
                        >
                            {{ pack.name }}
                        </option>
                    </select>
                    <div class="invalid-feedback d-block" *ngIf="subscriberForm.get('selectedBLPayerPackage')?.invalid && (subscriberForm.get('selectedBLPayerPackage')?.touched || subscriberForm.touched)">
                        Package is required.
                    </div>
                </div>

                <!-- Gender -->
                <div class="col-3">
                    <label>Gender</label><span class="danger"> *</span>
                    <select class="form-select no-invalid-icon" formControlName="Sex"
                        [class.is-invalid]="subscriberForm.get('Sex')?.invalid && (subscriberForm.get('Sex')?.touched || subscriberForm.touched)">
                        <option *ngFor="let g of genders" [value]="g.code">
                            {{ g.name }}
                        </option>
                    </select>
                    <div class="invalid-feedback d-block" *ngIf="subscriberForm.get('Sex')?.invalid && (subscriberForm.get('Sex')?.touched || subscriberForm.touched)">
                        Gender is required.
                    </div>
                </div>

                <!-- Insured ID -->
                <div class="col-3">
                    <label>Member Id / Emp Id</label
                    ><span class="danger"> *</span>
                    <input
                        type="text"
                        class="form-control no-invalid-icon"
                        formControlName="InsuredIdNo"
                        placeholder="Member Id / Emp Id"
                        [class.is-invalid]="subscriberForm.get('InsuredIdNo')?.invalid && (subscriberForm.get('InsuredIdNo')?.touched || subscriberForm.touched)"
                    />
                    <div class="invalid-feedback d-block" *ngIf="subscriberForm.get('InsuredIdNo')?.invalid && (subscriberForm.get('InsuredIdNo')?.touched || subscriberForm.touched)">
                        Member ID / Emp ID is required.
                    </div>
                </div>

                <!-- Active -->
                <div class="col-3 d-flex align-items-center mt-4">
                    <input
                        type="checkbox"
                        class="form-check-input"
                        formControlName="Inactive"
                    />
                    <label class="form-check-label ms-2">Active</label>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="card mt-4">
                        <b>
                            <a
                                class="nav-item nav-link active mt-2"
                                style="color: rgb(8, 8, 167); margin-left: 20px"
                            >
                                Copay Flat Rate (%)
                            </a>
                        </b>
                        <div class="row mt-2 mb-2 mx-2">
                            <div class="col-6">
                                <input
                                    type="number"
                                    class="form-control w-100 no-invalid-icon"
                                    placeholder="OP"
                                    formControlName="OpCopay"
                                />
                            </div>
                            <div class="col-6">
                                <input
                                    type="number"
                                    class="form-control w-100 no-invalid-icon"
                                    placeholder="IP"
                                    formControlName="Deductibles"
                                />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card mt-4">
                        <b>
                            <a
                                class="nav-item nav-link active mt-2"
                                style="color: rgb(8, 8, 167); margin-left: 20px"
                            >
                                Deductable (Amount)
                            </a>
                        </b>
                        <div class="row mt-2 mb-2 mx-2">
                            <div class="col-6">
                                <input
                                    type="number"
                                    class="form-control w-100 no-invalid-icon"
                                    placeholder="PC"
                                    formControlName="Copay"
                                />
                            </div>
                            <div class="col-6">
                                <input
                                    type="number"
                                    class="form-control w-100 no-invalid-icon"
                                    placeholder="DN"
                                    formControlName="DNDeductible"
                                />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <ul
                        ngbNav
                        #nav="ngbNav"
                        [(activeId)]="activeTabId"
                        class="nav nav-tabs mb-3"
                    >
                        <li [ngbNavItem]="1">
                            <a ngbNavLink>Policy Info</a>
                            <ng-template ngbNavContent>
                                <!-- ✅ Add Policy Button -->
                                <button
                                    class="btn btn-sm btn-primary mb-2"
                                    (click)="openPolicyModal(modalLg)"
                                >
                                    + Add Policy
                                </button>

                                <!-- ✅ Table -->
                                <div class="table-responsive">
                                    <table class="table align-middle mb-0">
                                        <thead class="thead-sm">
                                            <tr
                                                class="text-uppercase text-center"
                                            >
                                                <th>Effective Date</th>
                                                <th>Termination Date</th>
                                                <th>Group No</th>
                                                <th>No of Visits</th>
                                                <th>Amount</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody class="text-center">
                                            <tr
                                                *ngFor="
                                                    let policy of patient?.policyList
                                                "
                                            >
                                                <td>
                                                    {{
                                                        policy.effectiveDate
                                                            | date
                                                                : "dd/MM/yyyy h:mm a"
                                                    }}
                                                </td>
                                                <td>
                                                    {{
                                                        policy.terminationDate
                                                            | date
                                                                : "dd/MM/yyyy h:mm a"
                                                    }}
                                                </td>
                                                <td>
                                                    {{
                                                        policy.groupNo || "N/A"
                                                    }}
                                                </td>
                                                <td>
                                                    {{
                                                        policy.noOfVisits ||
                                                            "N/A"
                                                    }}
                                                </td>
                                                <td>
                                                    {{
                                                        policy.amount | currency
                                                    }}
                                                </td>
                                                <td>
                                                    {{ policy.status || "N/A" }}
                                                </td>
                                            </tr>
                                            <tr
                                                *ngIf="
                                                    patient?.policyList
                                                        ?.length === 0
                                                "
                                            >
                                                <td colspan="6">
                                                    No policy data available.
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- ✅ Modal Template -->
                                <ng-template #modalLg let-modal>
                                    <form
                                        [formGroup]="policyForm1"
                                        (ngSubmit)="onSavePolicy(modal)"
                                    >
                                        <div class="modal-header">
                                            <h5 class="modal-title">
                                                Add Policy
                                            </h5>
                                            <button
                                                type="button"
                                                class="btn-close"
                                                aria-label="Close"
                                                (click)="modal.dismiss()"
                                            ></button>
                                        </div>

                                        <div class="modal-body">
                                            <div class="row">
                                                <div class="col-4">
                                                    <label
                                                        >Effective Date</label
                                                    >
                                                    <input
                                                        type="date"
                                                        class="form-control"
                                                        formControlName="effectiveDate"
                                                    />
                                                </div>
                                                <div class="col-4">
                                                    <label
                                                        >Termination Date</label
                                                    >
                                                    <input
                                                        type="date"
                                                        class="form-control"
                                                        formControlName="terminationDate"
                                                    />
                                                </div>
                                                <div class="col-4">
                                                    <label>Group No</label>
                                                    <input
                                                        type="text"
                                                        class="form-control"
                                                        formControlName="groupNo"
                                                    />
                                                </div>
                                            </div>

                                            <div class="row mt-2">
                                                <div class="col-4">
                                                    <label>No of Visits</label>
                                                    <input
                                                        type="number"
                                                        class="form-control"
                                                        formControlName="noOfVisits"
                                                    />
                                                </div>
                                                <div class="col-4">
                                                    <label>Amount</label>
                                                    <input
                                                        type="number"
                                                        class="form-control"
                                                        formControlName="amount"
                                                    />
                                                </div>
                                                <div class="col-4">
                                                    <label>Status</label>
                                                    <input
                                                        type="text"
                                                        class="form-control"
                                                        formControlName="status"
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                        <!-- <div class="modal-footer">
                                            <button
                                                class="btn btn-secondary"
                                                type="button"
                                                (click)="modal.dismiss()"
                                            >
                                                Cancel
                                            </button>
                                            <button
                                                class="btn btn-primary"
                                                type="submit"
                                                [disabled]="policyForm1.invalid"
                                            >
                                                Save
                                            </button>
                                        </div> -->
                                        <div
                                            class="modal-footer justify-content-end"
                                        >
                                            <button
                                                class="btn btn-secondary"
                                                type="button"
                                                (click)="modal.dismiss()"
                                            >
                                                Cancel
                                            </button>
                                            <button
                                                class="btn btn-primary"
                                                type="submit"
                                                [disabled]="policyForm1.invalid"
                                            >
                                                Save
                                            </button>
                                        </div>
                                    </form>
                                </ng-template>
                            </ng-template>
                        </li>

                        <!-- 🟠 Tab 2: Copay Info -->
                        <li [ngbNavItem]="2">
                            <a ngbNavLink>Copay Info</a>
                            <ng-template ngbNavContent>
                                <form [formGroup]="copayForm" class="row g-3">
                                    <div class="col-6">
                                        <label>Type of Service</label>
                                        <input
                                            type="number"
                                            class="form-control w-100"
                                            placeholder=""
                                            formControlName="serviceType"
                                        />
                                    </div>
                                    <div class="col-md-6">
                                        <label>Copay (%)</label>
                                        <input
                                            type="number"
                                            class="form-control no-invalid-icon"
                                            formControlName="copayPercentage"
                                        />
                                    </div>
                                </form>
                            </ng-template>
                        </li>
                    </ul>

                    <div [ngbNavOutlet]="nav"></div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="d-flex justify-content-between mt-4">
                <!-- Left buttons: Save & Cancel -->
                <div>
                    <button
                        type="button"
                        class="btn btn-info"
                        (click)="openLargeModal(modalLg)"
                    >
                        Add Card
                    </button>
                </div>

                <!-- Right button: Add Card -->
                <div>
                    <button
                        type="submit"
                        class="btn btn-success"
                        (click)="insertsubscriber()"
                    >
                        Save
                    </button>
                    <button
                        type="button"
                        class="btn btn-secondary ms-2"
                        (click)="cancel()"
                    >
                        Cancel
                    </button>

                </div>
            </div>
            <ng-template #modalLg let-modal>
                <div class="modal-header">
                    <h4 class="modal-title">Upload Image</h4>
                    <button
                        type="button"
                        class="btn-close"
                        aria-label="Close"
                        (click)="modal.dismiss('Cross click')"
                    ></button>
                </div>

                <div class="modal-body">
                    <div class="d-flex flex-column align-items-start">
                        <label class="form-label mb-2">Select Image</label>

                        <div class="avatar-xxl">
                            <file-pond
                                name="filepond"
                                [options]="userFilePondConfig"
                                className="filepond-input-circle"
                            >
                            </file-pond>
                        </div>

                        <!-- 👇 Left-aligned Read Image Button -->
                        <button
                            pButton
                            type="button"
                            class="btn btn-primary mt-3"
                        >
                            Read Image
                        </button>
                    </div>

                    <!-- Close button aligned to right -->
                    <div
                        class="d-flex justify-content-end align-items-center mt-4"
                    >
                        <button
                            pButton
                            type="button"
                            class="btn btn-primary"
                            (click)="modal.close()"
                        >
                            Close
                        </button>
                    </div>
                </div>
            </ng-template>
        </form>
    </div>
<!-- </div> -->
