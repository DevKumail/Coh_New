<nav aria-label="breadcrumb">
  <ol class="breadcrumb bg-light bg-opacity-50 p-2 mb-2">
    <li class="breadcrumb-item">
      <a href="javascript:void(0);">
        <lucide-angular [img]="homeIcon" class="fs-6"></lucide-angular>
        Clinical
      </a>
    </li>
    <li class="d-flex align-items-center text-muted mx-1" aria-current="page">
      <lucide-angular [img]="chevronRightIcon" class="fs-6"></lucide-angular>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Alert</li>
  </ol>
</nav>

<form  *ngIf="alertForm" [formGroup]="alertForm" (ngSubmit)="onSubmit()">
  <div class="card p-3 shadow rounded">
    <h5 class="card-title mb-3 fw-bold d-inline-flex align-items-center gap-2">
      <lucide-angular [img]="bellIcon" class="me-2 fs-4"></lucide-angular>
      Alerts
    </h5>
    <input type="hidden" formControlName="mrno" />

    <div class="row">
      <div [ngClass]="getFormColClass()">
        <div class="mb-3">
          <label class="form-label">Alert Type</label>
          <select class="form-select" formControlName="alertType">
            <option [ngValue]="null" disabled>--- Select Alert Type ---</option>
            <option *ngFor="let alert of getAlert" [value]="alert.typeId">{{ alert.name }}</option>
          </select>
          <div class="text-danger small" *ngIf="alertForm.get('alertType')?.touched && alertForm.get('alertType')?.invalid">
            Alert Type is required.
          </div>
        </div>
      </div>

      <div [ngClass]="getFormColClass()">
        <div class="mb-3">
          <label class="form-label">Start Date</label>
          <input id="alertStartDate" type="text" class="form-control" formControlName="startDate" placeholder="dd/MM/yyyy" data-provider="flatpickr" />
          <div class="text-danger small" *ngIf="alertForm.get('startDate')?.touched && alertForm.get('startDate')?.invalid">
            Start Date is required.
          </div>
        </div>
      </div>

      <!-- Repeat Date appears only in update mode -->
      <div [ngClass]="getFormColClass()" *ngIf="buttontext === 'update'">
        <div class="mb-3">
          <label class="form-label">Repeat Date</label>
          <input id="alertRepeatDate" type="text" class="form-control" formControlName="repeatDate" placeholder="dd/MM/yyyy" data-provider="flatpickr" />
        </div>
      </div>

      <div [ngClass]="getFormColClass()">
        <div class="mb-3">
          <label class="form-label">Status</label>
          <select class="form-select" formControlName="status">
            <option [ngValue]="null" disabled>--- Select Status ---</option>
            <ng-container *ngFor="let status of Active">
              <option *ngIf="buttontext === 'update' || status.id !== 2" [ngValue]="status.id">
                {{ status.name }}
              </option>
            </ng-container>
          </select>
          <div class="text-danger small" *ngIf="alertForm.get('status')?.touched && alertForm.get('status')?.value == null">
            Status is required.
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <div class="mb-3">
          <label class="form-label">Message</label>
          <input type="text" class="form-control" formControlName="message" placeholder="Enter message" />
          <div class="text-danger small" *ngIf="alertForm.get('message')?.touched && alertForm.get('message')?.invalid">
            Message is required.
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-end">
      <button type="button" class="btn btn-light" (click)="clearForm()">Clear</button>
      <button type="submit" class="btn btn-primary ms-2"
        [title]="!SearchPatientData?.table2?.[0]?.mrNo ? 'Please load/select a patient (MRNO required)' : (alertForm.invalid ? 'Please fill all required fields' : '')">
        {{ buttontext === 'update' ? 'Update' : 'Save' }}
      </button>
    </div>
  </div>

  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-middle mb-0 table-striped">
            <thead class="thead-sm">
              <tr class="text-uppercase text-center">
                <th>Alert Type</th>
                <th>Start Date</th>
                <th>Repeat Date</th>
                <th>Message</th>
                <th>Entered By</th>
                <th>Entered Date</th>
                <th>Status</th>
                <th>Updated By</th>
                <th>Updated Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody  class="table-group-divider text-center">
              <tr *ngFor="let item of pagedAlerts">
                <td class="text-center">{{ getAlertTypeName(item.alertTypeId) }}</td>

                <td class="text-center">{{ item.startDate|date:'dd/MM/yyyy' }}</td>
                <td class="text-center">{{ item.repeatDate|date:'dd/MM/yyyy' }}</td>
                <td
                  class="text-center message-cell"
                  [ngbTooltip]="item.alertMessage"
                  container="body"
                  placement="top"
                  triggers="hover focus"
                  style="max-width: 340px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                >
                  {{ item.alertMessage }}
                </td>
                <td class="text-center">{{ item.enteredBy }}</td>
                <td class="text-center">{{ item.enteredDate|date:'dd/MM/yyyy' }}</td>
                <td class="text-center">{{ item.isFinished ? 'Completed' : (item.active ? 'Active' : 'Inactive') }}</td>
                <td class="text-center">{{ item.updatedBy }}</td>
                <td class="text-center">{{ item.updateDate | date:'dd/M/yyyy' }}</td>
                <td class="text-center align-middle actions-cell">
                  <div class="d-inline-flex justify-content-center align-items-center gap-2 text-nowrap actions-wrap">
                    <lucide-angular
                      [img]="editIcon"
                      [title]="item.isFinished ? 'Completed alerts cannot be edited' : 'Edit'"
                      aria-label="Edit"
                      class="text-primary fs-5 action-icon"
                      [class.opacity-50]="item.isFinished"
                      [style.pointer-events]="item.isFinished ? 'none' : 'auto'"
                      style="cursor: pointer;"
                      (click)="!item.isFinished && editAlert(item)"
                    ></lucide-angular>
                  </div>
                </td>
              </tr>
              <tr *ngIf="pagedAlerts?.length === 0">
                <td colspan="10" class="text-center">No alerts found.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="d-flex flex-column align-items-center mt-3 gap-2">
          <div class="d-flex justify-content-end align-items-center bg-light rounded px-3 py-2 gap-3 w-100 flex-wrap">
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <div class="me-2">
                Showing {{ start + 1 }} to {{ end > totalItems ? totalItems : end }} of {{ totalItems }} entries
              </div>
              <div>
                <select class="form-select form-select-sm" style="width: auto;" [(ngModel)]="pageSize"
                  [ngModelOptions]="{ standalone: true }" (change)="onPageSizeChange($event)">
                  <option *ngFor="let size of pageSizes" [value]="size">{{ size }}</option>
                </select>
              </div>
            </div>

            <nav>
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item" [class.disabled]="currentPage === 1">
                  <button type="button" class="page-link" (click)="prevPage()">Previous</button>
                </li>
                <li class="page-item" *ngFor="let page of pageNumbers" [class.active]="page === currentPage" [class.disabled]="page === '...'">
                  <ng-container *ngIf="page !== '...'; else ellipsisTpl">
                    <button type="button" class="page-link" (click)="goToPage(+page)">{{ page }}</button>
                  </ng-container>
                  <ng-template #ellipsisTpl>
                    <span class="page-link">&hellip;</span>
                  </ng-template>
                </li>
                <li class="page-item" [class.disabled]="currentPage === totalPages">
                  <button type="button" class="page-link" (click)="nextPage()">Next</button>
                </li>
              </ul>
            </nav>

          </div>
        </div>

      </div>
    </div>
  </div>
</form>