<div class="row g-1" [formGroup]="form">
    <!-- Skeleton Loader -->
    <ng-container *ngIf="isLoading">
        <div class="col-lg-4" *ngFor="let i of [1,2,3]">
            <div class="card shadow-sm">
                <div class="card-header py-1 bg-light">
                    <div class="placeholder-glow">
                        <span class="placeholder col-3"></span>
                    </div>
                </div>
                <div class="card-body p-2">
                    <div class="row g-2">
                        <div class="col-6" *ngFor="let j of [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]">
                            <div class="placeholder-glow">
                                <span class="placeholder col-8 mb-1" style="height: 12px;"></span>
                                <span class="placeholder col-12" style="height: 31px;"></span>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="placeholder-glow">
                                <span class="placeholder col-4 mb-1" style="height: 12px;"></span>
                                <span class="placeholder col-12" style="height: 70px;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </ng-container>

    <!-- Actual Content -->
    <ng-container *ngIf="!isLoading && childrenData.length > 0" formArrayName="children">
        <ng-container *ngFor="let child of childrenData; let i = index">
            <div class="col-lg-4" [formGroupName]="i">
                <div class="card shadow-sm">
                    <div class="card-header py-1 bg-light"><strong>Child {{ i + 1 }}</strong></div>
                    <div class="card-body p-2">
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label mb-0">Date of birth</label>
                                <input type="date" class="form-control form-control-sm" formControlName="dateOfBirth" />
                            </div>
                            <div class="col-6">
                                <label class="form-label mb-0">CDB</label>
                                <input type="date" class="form-control form-control-sm" formControlName="cdb" [disabled]="true" />
                            </div>
                            <div class="col-6">
                                <label class="form-label mb-0">Week</label>
                                <input type="number" class="form-control form-control-sm" formControlName="week" />
                            </div>
                            <div class="col-6">
                                <label class="form-label mb-0">Gender</label>
                                <select class="form-select form-select-sm" formControlName="gender" filledOnValue>
                                    <option value="">Select Gender</option>
                                    <option *ngFor="let gender of genders" [value]="gender.code">{{ gender.name }}</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label mb-0">Delivery method</label>
                                <select class="form-select form-select-sm" formControlName="deliveryMethod" filledOnValue>
                                    <option value="">Select...</option>
                                    <option *ngFor="let opt of options('DeliveryMethod')" [value]="opt.valueId">{{ opt.name }}</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label mb-0">Weight [g]</label>
                                <input class="form-control form-control-sm" type="number" formControlName="weight" />
                            </div>
                            <div class="col-6">
                                <label class="form-label mb-0">Length [cm]</label>
                                <input class="form-control form-control-sm" type="number" formControlName="length" />
                            </div>
                            <div class="col-6">
                                <label class="form-label mb-0">Head circumference [cm]</label>
                                <input class="form-control form-control-sm" type="number" formControlName="headCircumference" />
                            </div>
                            <div class="col-6">
                                <label class="form-label mb-0">APGAR 1</label>
                                <input type="number" class="form-control form-control-sm" formControlName="apgar1" />
                            </div>
                            <div class="col-6">
                                <label class="form-label mb-0">APGAR 5</label>
                                <input type="number" class="form-control form-control-sm" formControlName="apgar5" />
                            </div>
                            <!-- <div class="col-6">
                                <label class="form-label mb-0">Condition</label>
                                <input class="form-control form-control-sm" formControlName="condition" />
                            </div> -->
                            <div class="col-6">
                                <label class="form-label mb-0">Death post-partum on</label>
                                <input type="date" class="form-control form-control-sm" formControlName="deathPostPartumOn" />
                            </div>
                            <div class="col-6">
                                <label class="form-label mb-0">Died perinatally on</label>
                                <input type="date" class="form-control form-control-sm" formControlName="diedPerinatallyOn" />
                            </div>
                            <!-- <div class="col-6">
                                <label class="form-label mb-0">Identity number</label>
                                <input class="form-control form-control-sm" formControlName="identityNumber" />
                            </div> -->
                            <div class="col-6">
                                <label class="form-label mb-0">First name</label>
                                <input class="form-control form-control-sm" formControlName="firstName" />
                            </div>
                            <div class="col-6">
                                <label class="form-label mb-0">Surname</label>
                                <input class="form-control form-control-sm" formControlName="surname" />
                            </div>
                            <div class="col-6">
                                <label class="form-label mb-0">Place of birth</label>
                                <input class="form-control form-control-sm" formControlName="placeOfBirth" />
                            </div>
                            <div class="col-6">
                                <label class="form-label mb-0">Country of birth</label>
                                <select class="form-select form-select-sm" formControlName="countryOfBirth" filledOnValue>
                                    <option value="">Select Country</option>
                                    <option *ngFor="let country of countries" [value]="country.code">{{ country.name }}</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label mb-0">Note</label>
                                <textarea class="form-control form-control-sm" rows="3" formControlName="note"></textarea>
                            </div>

                            <!-- ICD 10 boxed group -->
                            <div class="col-12">
                                <div class="border rounded">
                                    <div class="d-flex align-items-center gap-2 px-2 py-1 border-bottom bg-light">
                                        <label class="form-label mb-0 fw-semibold small">Chromosome anomaly (ICD-10)</label>
                                    </div>
                                    <div class="p-2">
                                        <div class="dropdown w-100">
                                            <button class="btn btn-sm border w-100 text-start d-flex justify-content-between align-items-center"
                                                type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <span class="text-truncate">
                                                    <span *ngIf="getSelectedChromosomes(i).length === 0" class="text-muted">Select chromosome anomaly...</span>
                                                    <span *ngIf="getSelectedChromosomes(i).length > 0">{{ getSelectedChromosomes(i).join(', ') }}</span>
                                                </span>
                                                <i class="bi bi-chevron-down ms-2"></i>
                                            </button>
                                            <ul class="dropdown-menu w-100" data-bs-auto-close="outside">
                                                <li class="px-2 py-1 sticky-top bg-white" style="z-index: 10;">
                                                    <input type="text" class="form-control form-control-sm" placeholder="Search..."
                                                        [ngModel]="searchChromosome" (ngModelChange)="onChromosomeSearchChange($event, i)"
                                                        [ngModelOptions]="{standalone: true}">
                                                </li>
                                                <li><hr class="dropdown-divider m-0"></li>
                                                <li>
                                                    <div style="max-height: 260px; overflow: auto;" (scroll)="onChromosomeScroll($event, i)">
                                                        <div *ngFor="let opt of filteredChromosomeOptions" class="px-2 py-1">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" 
                                                                    [checked]="isChromosomeSelected(opt, i)"
                                                                    (click)="$event.stopPropagation()" 
                                                                    (change)="toggleChromosome(opt, i)">
                                                                <label class="form-check-label"
                                                                    (click)="$event.preventDefault(); $event.stopPropagation(); toggleChromosome(opt, i)">
                                                                    {{ opt }}
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Congenital malformation boxed group -->
                            <div class="col-12">
                                <div class="border rounded">
                                    <div class="d-flex align-items-center gap-2 px-2 py-1 border-bottom bg-light">
                                        <label class="form-label mb-0 fw-semibold small">Congenital malformation (ICD-10)</label>
                                    </div>
                                    <div class="p-2">
                                        <div class="dropdown w-100">
                                            <button class="btn btn-sm border w-100 text-start d-flex justify-content-between align-items-center"
                                                type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <span class="text-truncate">
                                                    <span *ngIf="getSelectedMalformations(i).length === 0" class="text-muted">Select congenital malformation...</span>
                                                    <span *ngIf="getSelectedMalformations(i).length > 0">{{ getSelectedMalformations(i).join(', ') }}</span>
                                                </span>
                                                <i class="bi bi-chevron-down ms-2"></i>
                                            </button>
                                            <ul class="dropdown-menu w-100" data-bs-auto-close="outside">
                                                <li class="px-2 py-1 sticky-top bg-white" style="z-index: 10;">
                                                    <input type="text" class="form-control form-control-sm" placeholder="Search..."
                                                        [ngModel]="searchMalformation" (ngModelChange)="onMalformationSearchChange($event, i)"
                                                        [ngModelOptions]="{standalone: true}">
                                                </li>
                                                <li><hr class="dropdown-divider m-0"></li>
                                                <li>
                                                    <div style="max-height: 260px; overflow: auto;" (scroll)="onMalformationScroll($event, i)">
                                                        <div *ngFor="let opt of filteredMalformationOptions" class="px-2 py-1">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" 
                                                                    [checked]="isMalformationSelected(opt, i)"
                                                                    (click)="$event.stopPropagation()" 
                                                                    (change)="toggleMalformation(opt, i)">
                                                                <label class="form-check-label"
                                                                    (click)="$event.preventDefault(); $event.stopPropagation(); toggleMalformation(opt, i)">
                                                                    {{ opt }}
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </ng-container>
    </ng-container>
</div>
