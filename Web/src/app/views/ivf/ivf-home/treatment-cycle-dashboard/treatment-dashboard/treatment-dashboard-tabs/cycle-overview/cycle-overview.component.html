<div class="treatment-dashboard">
  <!-- Top Navigation Tabs -->
  <!-- <div class="dashboard-tabs mb-3">
    <div class="d-flex gap-2 flex-wrap">
      <button class="btn btn-sm btn-success">Overview</button>
      <button class="btn btn-sm btn-outline-secondary">Aspiration</button>
      <button class="btn btn-sm btn-outline-secondary">Culture</button>
      <button class="btn btn-sm btn-outline-secondary">Transfer</button>
      <button class="btn btn-sm btn-outline-secondary">Luteal phase</button>
      <button class="btn btn-sm btn-outline-secondary">Pregnancy</button>
      <button class="btn btn-sm btn-outline-secondary">Birth</button>
      <button class="btn btn-sm btn-outline-secondary ms-auto">Summaries</button>
    </div>
  </div> -->

  <!-- Cycle Overview Section -->
  <!-- <div class="card mb-3">
    <div class="card-header bg-dark text-white py-1">
      <strong>Cycle overview</strong>
    </div>
  </div> -->

  <!-- FullCalendar Timeline -->
  <div class="card">
    <div class="card-body p-2">
      <full-calendar [options]="calendarOptions"></full-calendar>
    </div>
  </div>

  <!-- Add Event Modal (Events only) -->
  <ng-template #addEventModal let-modal>
    <div class="modal-header py-2">
      <h6 class="modal-title" id="modal-basic-title">Add Event</h6>
      <button type="button" class="btn-close" aria-label="Close" (click)="closeAddModal()"></button>
    </div>
    <form class="p-3 pt-2" (ngSubmit)="submitAddForm()">
      <div class="mb-2">
        <label class="form-label mb-1">Event type</label>
        <select class="form-select form-select-sm" [(ngModel)]="addForm.subtype" name="subtype_events">
          <option *ngFor="let s of eventSubtypes" [value]="s">{{ s }}</option>
        </select>
      </div>
      <div class="row g-2 mb-2">
        <div class="col-6">
          <label class="form-label mb-1">Start date</label>
          <input type="date" class="form-control form-control-sm" [(ngModel)]="addForm.start" name="start" />
        </div>
        <div class="col-6">
          <label class="form-label mb-1">End date</label>
          <input type="date" class="form-control form-control-sm" [(ngModel)]="addForm.end" name="end" />
        </div>
      </div>
      <div class="d-flex justify-content-end gap-2 mt-3">
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="closeAddModal()">Cancel</button>
        <button type="submit" class="btn btn-sm btn-primary">Add</button>
      </div>
    </form>
  </ng-template>

  <!-- Add Medication Dose Modal (Medication only) -->
  <ng-template #addDoseModal let-modal>
    <div class="modal-header py-2">
      <h6 class="modal-title">Add Medication Dose</h6>
      <button type="button" class="btn-close" aria-label="Close" (click)="closeAddModal()"></button>
    </div>
    <form class="p-3 pt-2" (ngSubmit)="submitAddForm()">
      <div class="mb-2">
        <label class="form-label mb-1">Medication</label>
        <select class="form-select form-select-sm" [(ngModel)]="addForm.subtype" name="subtype_meds">
          <option *ngFor="let s of medicationSubtypes" [value]="s">{{ s }}</option>
        </select>
      </div>
      <div class="row g-2 mb-2">
        <div class="col-6">
          <label class="form-label mb-1">Start date</label>
          <input type="date" class="form-control form-control-sm" [(ngModel)]="addForm.start" name="start" />
        </div>
        <div class="col-6">
          <label class="form-label mb-1">End date</label>
          <input type="date" class="form-control form-control-sm" [(ngModel)]="addForm.end" name="end" />
        </div>
      </div>
      <div class="d-flex justify-content-end gap-2 mt-3">
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="closeAddModal()">Cancel</button>
        <button type="submit" class="btn btn-sm btn-primary">Add</button>
      </div>
    </form>
  </ng-template>

  <!-- Add Hormone Modal (Hormone only) -->
  <ng-template #addHormoneAddModal let-modal>
    <div class="modal-header py-2">
      <h6 class="modal-title">Add Hormone Value</h6>
      <button type="button" class="btn-close" aria-label="Close" (click)="closeAddModal()"></button>
    </div>
    <form class="p-3 pt-2" (ngSubmit)="submitAddForm()">
      <div class="mb-2">
        <label class="form-label mb-1">Hormone</label>
        <select class="form-select form-select-sm" [(ngModel)]="addForm.subtype" name="subtype_hormone">
          <option *ngFor="let s of hormoneSubtypes" [value]="s">{{ s }}</option>
        </select>
      </div>
      <div class="row g-2 mb-2">
        <div class="col-6">
          <label class="form-label mb-1">Start date</label>
          <input type="date" class="form-control form-control-sm" [(ngModel)]="addForm.start" name="start" />
        </div>
        <div class="col-6">
          <label class="form-label mb-1">End date</label>
          <input type="date" class="form-control form-control-sm" [(ngModel)]="addForm.end" name="end" />
        </div>
      </div>
      <div class="d-flex justify-content-end gap-2 mt-3">
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="closeAddModal()">Cancel</button>
        <button type="submit" class="btn btn-sm btn-primary">Add</button>
      </div>
    </form>
  </ng-template>

  <!-- Add Medication Resource Modal -->
  <ng-template #addMedModal let-modal>
    <div class="modal-header py-2">
      <h6 class="modal-title">Add Medication Row</h6>
      <button type="button" class="btn-close" aria-label="Close" (click)="closeAddMedModal()"></button>
    </div>
    <form class="p-3 pt-2" (ngSubmit)="confirmAddMed()" [formGroup]="medFG">
      <div class="row g-2 align-items-end mb-2">
        <div class="col-8">
          <label class="form-label mb-1">Medication</label>
          <div ngbDropdown #medDd="ngbDropdown" class="d-block" autoClose="true">
            <div ngbDropdownToggle tabindex="0" role="button"
                 class="form-control form-control-sm w-100 position-relative"
                 style="white-space: normal; overflow-wrap: anywhere; min-height: 32px; display: block; padding-right: 24px;"
                 [title]="selectedDrugLabel || '-- Select drug --'">
              <ng-container *ngIf="selectedDrugLabel; else medPlaceholder">
                {{ selectedDrugLabel }}
              </ng-container>
              <ng-template #medPlaceholder><span class="text-muted">-- Select drug --</span></ng-template>
            </div>
            <div ngbDropdownMenu class="w-100 p-0">
              <div class="p-2 border-bottom bg-white">
                <div class="input-group input-group-sm">
                  <input type="text" class="form-control" placeholder="Type 3+ chars to search..."
                         [(ngModel)]="medSearch" [ngModelOptions]="{standalone: true}"
                         (input)="onMedSearchChange()" (keyup)="onMedSearchChange()" />
                  <button class="btn btn-outline-secondary" type="button" (click)="medSearch=''; onMedSearchChange()">Clear</button>
                </div>
              </div>
              <div class="table-responsive" style="max-height: 320px; overflow: auto;" (scroll)="onDrugsScroll($event)">
                <table class="table table-bordered table-striped table-sm">
                  <thead class="table-light" style="position: sticky; top: 0; z-index: 2; background: #f8f9fa;">
                    <tr>
                      <th style="min-width: 220px;">Drug</th>
                      <th style="min-width: 60px;">Color</th>
                      <th style="min-width: 60px;">Unit</th>
                      <th style="min-width: 140px;">Presentation</th>
                      <th style="min-width: 160px;">Application domain</th>
                      <th style="min-width: 120px;">Drug code</th>
                      <th style="min-width: 140px;">Packaging</th>
                    </tr>
                  </thead>
                  <tbody class="table-group-divider">
                    <tr *ngFor="let d of drugs" (click)="pickDrug(d); medDd.close()" style="cursor: pointer;">
                      <td>
                        <div class="fw-semibold text-wrap">{{ d.drugName }}</div>
                        <div class="text-muted small" *ngIf="d.dose">{{ d.dose }}</div>
                      </td>
                      <td>
                        <span class="d-inline-block" [style.width.px]="14" [style.height.px]="14" [style.borderRadius.px]="3"
                              [style.backgroundColor]="drugColor(d)" style="border: 1px solid #999;"></span>
                      </td>
                      <td class="text-muted">{{ d.dose || '-' }}</td>
                      <td>{{ d.dosageForm || d.form || '-' }}</td>
                      <td class="text-muted">{{ d.applicationDomain || '-' }}</td>
                      <td class="text-muted">{{ d.greenRainCode || '-' }}</td>
                      <td class="text-muted">{{ d.packageName || '-' }}</td>
                    </tr>
                    <tr *ngIf="drugsLoading">
                      <td colspan="7" class="text-center text-muted py-2">Loadingâ€¦</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="col-4">
          <label class="form-label mb-1">Drug code</label>
          <input type="text" class="form-control form-control-sm" formControlName="drugCode" [disabled]="true">
        </div>
      </div>

      <div class="mb-2">
        <label class="form-label mb-1 d-block">Application domain</label>
        <div class="border rounded p-2">
          <div class="row g-2">
            <div class="col-6" *ngFor="let o of options('ApplicationDomain')">
              <div class="form-check">
                <input class="form-check-input" type="radio"
                       [value]="o.valueId" formControlName="applicationDomainCategoryId"
                       [id]="'appDom_'+o.valueId">
                <label class="form-check-label" [for]="'appDom_'+o.valueId">{{ o.name }}</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-2 mb-2">
        <div class="col-4">
          <label class="form-label mb-1">Start Date</label>
          <input type="date" class="form-control form-control-sm" formControlName="startDate">
        </div>
           <div class="col-4">
          <label class="form-label mb-1">Duration</label>
          <div class="input-group input-group-sm">
            <input type="number" min="0" class="form-control form-control-sm" formControlName="duration">
            <span class="input-group-text">day(s)</span>
          </div>
        </div>
      </div>

      <div class="row g-2 mb-2">
        <div class="col-4">
          <label class="form-label mb-1">Strength</label>
          <input type="text" class="form-control form-control-sm" formControlName="strength">
        </div>
        <div class="col-4">
          <label class="form-label mb-1">Route</label>
          <select class="form-select form-select-sm" formControlName="route">
            <option [ngValue]="''">-- Select route --</option>
             <option *ngFor="let r of GetRoute" [ngValue]="r?.name || r?.frequencyName || r">
              {{ r?.name || r?.frequencyName || r }}
            </option>
          </select>
        </div>

        <div class="col-4">
          <label class="form-label mb-1">Frequency</label>
          <select class="form-select form-select-sm" formControlName="frequency">
            <option [ngValue]="''">-- Select frequency --</option>
            <option *ngFor="let f of getfrequency" [ngValue]="f?.name || f?.frequencyName || f">
              {{ f?.name || f?.frequencyName || f }}
            </option>
          </select>
        </div>
        <div class="col-4">
          <label class="form-label mb-1">Quantity</label>
          <input type="text" class="form-control form-control-sm" formControlName="quantity">
        </div>
        <div class="col-4">
          <label class="form-label mb-1">Refill(s)</label>
          <input type="text" class="form-control form-control-sm" formControlName="refills">
        </div>

        <div class="col-4">
          <label class="form-label mb-1">Sample(s)</label>
          <input type="text" class="form-control form-control-sm" formControlName="samples">
        </div>
        <div class="col-4">
          <label class="form-label mb-1">Substitution</label>
          <select class="form-select form-select-sm" formControlName="substitution">
            <option [ngValue]="''">-- Select substitution --</option>
            <option *ngFor="let o of options('Substitution')" [ngValue]="o.name">{{ o.name }}</option>
          </select>
        </div>

        <div class="col-4">
        <label class="form-label mb-1">Indication</label>
        <select class="form-select form-select-sm" formControlName="indication">
          <option [ngValue]="''">-- Select indication --</option>
          <option *ngFor="let o of options('Indication')" [ngValue]="o.name">{{ o.name }}</option>
        </select>
      </div>

           <div class="col-4">
          <label class="form-label mb-1">Role Name</label>
          <select class="form-select form-select-sm" formControlName="roleName">
            <option [ngValue]="''">-- None --</option>
          </select>
        </div>

         
        <div class="col-4">
          <label class="form-label mb-1">Receiver Name</label>
            <select class="form-select form-select-sm flex-grow-1" formControlName="receiverName">
              <option [ngValue]="''">-- None --</option>
            </select>
        </div>

          <div class="form-check mb-0 col-4">
              <input class="form-check-input" type="checkbox" formControlName="internalOrder" id="internalOrder">
              <label class="form-check-label" for="internalOrder" style="font-size: 0.875rem;">
                Internal Order
              </label>
          </div>
      </div>

      <!-- Dynamic dose time inputs based on Frequency -->
      <div class="row g-2 mb-2" *ngIf="doseTimesFA?.length" formArrayName="doseTimes">
        <div class="col-12">
          <label class="form-label mb-1">Times</label>
          <div class="row g-2">
            <div class="col-3" *ngFor="let c of doseTimesFA.controls; index as i">
              <input type="time" class="form-control form-control-sm" [formControlName]="i">
            </div>
          </div>
        </div>
      </div>

      <div class="mb-2">
        <label class="form-label mb-1">Instructions</label>
        <textarea class="form-control form-control-sm" rows="3" formControlName="instructions"></textarea>
      </div>



      <div class="d-flex justify-content-end gap-2 mt-3">
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="closeAddMedModal()">Cancel</button>
        <button type="submit" class="btn btn-sm btn-primary">Add</button>
      </div>
    </form>
  </ng-template>

  <!-- Ultrasound Detail Modal -->
  <ng-template #ultrasoundModal let-modal>
    <div class="modal-header py-2">
      <h6 class="modal-title" id="ultra-title">Ultrasound Report</h6>
      <button type="button" class="btn-close" aria-label="Close" (click)="closeUltrasoundModal()"></button>
    </div>
    <div class="p-3 pt-2" *ngIf="ultrasoundDetail as u">
      <div class="mb-2">
        <strong>Report ID:</strong> #{{ u.reportId }}
      </div>
      <div class="mb-2">
        <strong>Measurements</strong>
        <div class="mt-1 small">
          <div>Endometrium: {{ u.measurements?.endom }} mm</div>
          <div>Total Follicles: {{ u.measurements?.total }}</div>
          <div>Left Leading Follicle: {{ u.measurements?.leftFoll }} mm</div>
          <div>Right Leading Follicle: {{ u.measurements?.rightFoll }} mm</div>
        </div>
      </div>
      <div class="mb-2">
        <strong>Images:</strong> {{ u.images?.length || 0 }} file(s)
      </div>
      <div class="d-flex justify-content-end gap-2 mt-3">
        <button type="button" class="btn btn-sm btn-secondary" (click)="closeUltrasoundModal()">Close</button>
      </div>
    </div>
  </ng-template>

  <!-- Lab Order Modal -->
  <ng-template #labOrderModal let-modal>
    <div class="modal-header py-2">
      <h6 class="modal-title" id="lab-title">Lab Order Details</h6>
      <button type="button" class="btn-close" aria-label="Close" (click)="closeLabOrderModal()"></button>
    </div>
    <div class="p-3 pt-2" *ngIf="labOrderDetail as l">
      <div class="mb-2"><strong>Order ID:</strong> #{{ l.orderId }}</div>
      <div class="mb-2"><strong>Test Name:</strong> {{ l.testName }}</div>
      <div class="mb-2"><strong>Status:</strong> {{ l.status }}</div>
      <div class="mb-2"><strong>Images:</strong> {{ l.images?.length || 0 }} file(s)</div>
      <div class="d-flex justify-content-end gap-2 mt-3">
        <button type="button" class="btn btn-sm btn-secondary" (click)="closeLabOrderModal()">Close</button>
      </div>
    </div>
  </ng-template>

  <!-- Medication Dose Modal -->
  <ng-template #medicationModal let-modal>
    <div class="modal-header py-2">
      <h6 class="modal-title" id="med-title">Medication Details</h6>
      <button type="button" class="btn-close" aria-label="Close" (click)="closeMedicationModal()"></button>
    </div>
    <div class="p-3 pt-2" *ngIf="medicationDetail as m">
      <div class="mb-2"><strong>Medication:</strong> {{ m.medicationName }}</div>
      <div class="mb-2"><strong>Dose:</strong> {{ m.dose }}</div>
      <div class="mb-2"><strong>Date:</strong> {{ m.date }}</div>
      <div class="mb-2" *ngIf="m.route"><strong>Route:</strong> {{ m.route }}</div>
      <div class="mb-2" *ngIf="m.notes"><strong>Notes:</strong> {{ m.notes }}</div>
      <div class="d-flex justify-content-end gap-2 mt-3">
        <button type="button" class="btn btn-sm btn-secondary" (click)="closeMedicationModal()">Close</button>
      </div>
    </div>
  </ng-template>

  <!-- Hormone Level Modal -->
  <ng-template #hormoneModal let-modal>
    <div class="modal-header py-2">
      <h6 class="modal-title" id="hormone-title">Hormone Level Details</h6>
      <button type="button" class="btn-close" aria-label="Close" (click)="closeHormoneModal()"></button>
    </div>
    <div class="p-3 pt-2" *ngIf="hormoneDetail as h">
      <div class="mb-2"><strong>Hormone:</strong> {{ h.hormoneName }}</div>
      <div class="mb-2"><strong>Value:</strong> {{ h.value }}</div>
      <div class="mb-2"><strong>Date:</strong> {{ h.date }}</div>
      <div class="mb-2" *ngIf="h.normalRange"><strong>Normal Range:</strong> {{ h.normalRange }}</div>
      <div class="mb-2" *ngIf="h.status"><strong>Status:</strong> {{ h.status }}</div>
      <div class="mb-2" *ngIf="h.notes"><strong>Notes:</strong> {{ h.notes }}</div>
      <div class="d-flex justify-content-end gap-2 mt-3">
        <button type="button" class="btn btn-sm btn-secondary" (click)="closeHormoneModal()">Close</button>
      </div>
    </div>
  </ng-template>
</div>
